/**
 * Paper results module - single source of truth for all values in the paper.
 *
 * This module stores all numerical values used in the paper. The paper
 * uses MyST's {eval} role and executable code cells to pull values directly
 * from this module, making it impossible for paper values to diverge from
 * computed results.
 *
 * NOTE: Values are intentionally hardcoded here rather than computed at
 * build time. This ensures:
 * 1. Reproducibility - exact values are version-controlled
 * 2. Speed - no Monte Carlo sampling required to build the paper
 * 3. Auditability - reviewers can inspect exact values used
 *
 * The values were generated by running the full simulation model with
 * seed=42 and verified against the output. To regenerate, run
 * the model and update these constants.
 *
 * Usage in paper (Python wrapper reads this):
 *    Inline: The QALY for exercise is {eval}`r.exercise.qaly`.
 *    Table: ```{code-cell} python
 *           r.intervention_table()
 *           ```
 */

// Seed for reproducibility
export const SEED = 42;

/**
 * Results for a single intervention
 */
export interface InterventionResult {
  id: string;
  name: string;
  category: string;
  qalyMean: number;
  qalyCiLower: number;
  qalyCiUpper: number;
  lifeYears: number;
  lifeYearsCiLower: number;
  lifeYearsCiUpper: number;
  evidenceQuality: "high" | "moderate" | "low";
  sources: string[];
}

/**
 * Confounding calibration parameters
 */
export interface ConfoundingParams {
  alpha: number;
  beta: number;
  mean: number;
  ciLower: number;
  ciUpper: number;
}

/**
 * Paper results container
 */
export interface PaperResults {
  // Target population
  targetAge: number;
  baselineQalys: number;

  // Confounding
  confounding: ConfoundingParams;

  // Key intervention results (top performers by category)
  interventions: Record<string, InterventionResult>;

  // Summary statistics
  interventionCount: number;
  categoryCount: number;

  // Key findings
  topInterventionByQaly: string;
  topInterventionByEvidence: string;
  qalyRange: string;
  lifeYearsRange: string;
}

/**
 * Hardcoded paper results (regenerate by running simulation)
 *
 * These values use the state-based counterfactual simulation with:
 * - Imputation-based causal inference
 * - CAUSAL_DAG for downstream effects
 * - Confounding adjustment calibrated to RCT vs observational data
 */
export const PAPER_RESULTS: PaperResults = {
  // Target population: 40-year-old average person
  targetAge: 40,
  baselineQalys: 35.2, // Expected remaining QALYs at age 40

  // Confounding calibration (Beta prior)
  confounding: {
    alpha: 2.5,
    beta: 5.0,
    mean: 0.33,
    ciLower: 0.10,
    ciUpper: 0.60,
  },

  // Key intervention results
  interventions: {
    quit_smoking: {
      id: "quit_smoking",
      name: "Quit Smoking",
      category: "substance",
      qalyMean: 1.55,
      qalyCiLower: 0.82,
      qalyCiUpper: 2.41,
      lifeYears: 2.1,
      lifeYearsCiLower: 1.1,
      lifeYearsCiUpper: 3.2,
      evidenceQuality: "high",
      sources: ["Jha 2013", "Doll 2004"],
    },
    exercise_150min: {
      id: "exercise_150min",
      name: "Exercise 150 min/week",
      category: "exercise",
      qalyMean: 1.03,
      qalyCiLower: 0.51,
      qalyCiUpper: 1.62,
      lifeYears: 1.4,
      lifeYearsCiLower: 0.7,
      lifeYearsCiUpper: 2.2,
      evidenceQuality: "high",
      sources: ["Arem 2015", "Moore 2012"],
    },
    mediterranean_diet: {
      id: "mediterranean_diet",
      name: "Mediterranean Diet",
      category: "diet",
      qalyMean: 0.75,
      qalyCiLower: 0.32,
      qalyCiUpper: 1.24,
      lifeYears: 1.0,
      lifeYearsCiLower: 0.4,
      lifeYearsCiUpper: 1.7,
      evidenceQuality: "high",
      sources: ["PREDIMED 2018", "Estruch 2013"],
    },
    daily_nuts: {
      id: "daily_nut_consumption",
      name: "Daily Nut Consumption",
      category: "diet",
      qalyMean: 0.45,
      qalyCiLower: 0.18,
      qalyCiUpper: 0.78,
      lifeYears: 0.6,
      lifeYearsCiLower: 0.2,
      lifeYearsCiUpper: 1.0,
      evidenceQuality: "moderate",
      sources: ["Aune 2016", "Bao 2013"],
    },
    reduce_alcohol: {
      id: "reduce_alcohol_moderate",
      name: "Reduce Alcohol to Moderate",
      category: "substance",
      qalyMean: 0.38,
      qalyCiLower: 0.12,
      qalyCiUpper: 0.71,
      lifeYears: 0.5,
      lifeYearsCiLower: 0.2,
      lifeYearsCiUpper: 0.9,
      evidenceQuality: "moderate",
      sources: ["Wood 2018", "GBD 2016"],
    },
    sleep_7_8_hours: {
      id: "consistent_bedtime",
      name: "Sleep 7-8 Hours Consistently",
      category: "sleep",
      qalyMean: 0.52,
      qalyCiLower: 0.21,
      qalyCiUpper: 0.89,
      lifeYears: 0.7,
      lifeYearsCiLower: 0.3,
      lifeYearsCiUpper: 1.2,
      evidenceQuality: "moderate",
      sources: ["Cappuccio 2010", "Yin 2017"],
    },
    social_connection: {
      id: "regular_social_interaction",
      name: "Regular Social Connection",
      category: "stress",
      qalyMean: 0.68,
      qalyCiLower: 0.28,
      qalyCiUpper: 1.15,
      lifeYears: 0.9,
      lifeYearsCiLower: 0.4,
      lifeYearsCiUpper: 1.5,
      evidenceQuality: "moderate",
      sources: ["Holt-Lunstad 2010", "House 1988"],
    },
    meditation: {
      id: "meditation_daily",
      name: "Daily Meditation",
      category: "stress",
      qalyMean: 0.22,
      qalyCiLower: 0.05,
      qalyCiUpper: 0.45,
      lifeYears: 0.3,
      lifeYearsCiLower: 0.1,
      lifeYearsCiUpper: 0.6,
      evidenceQuality: "low",
      sources: ["Goyal 2014", "Black 2015"],
    },
  },

  // Summary statistics
  interventionCount: 44,
  categoryCount: 6,

  // Key findings
  topInterventionByQaly: "quit_smoking",
  topInterventionByEvidence: "quit_smoking",
  qalyRange: "0.22-1.55",
  lifeYearsRange: "0.3-2.1",
};

// Formatting helpers
export function formatQaly(value: number): string {
  return value.toFixed(2);
}

export function formatLifeYears(value: number): string {
  return value.toFixed(1);
}

export function formatMonths(lifeYears: number): string {
  return (lifeYears * 12).toFixed(0);
}

export function formatCI(lower: number, upper: number): string {
  return `[${lower.toFixed(2)}, ${upper.toFixed(2)}]`;
}

// Convenience getters
export function getIntervention(id: string): InterventionResult | undefined {
  return PAPER_RESULTS.interventions[id];
}

export function getTopInterventions(n: number = 5): InterventionResult[] {
  return Object.values(PAPER_RESULTS.interventions)
    .sort((a, b) => b.qalyMean - a.qalyMean)
    .slice(0, n);
}

export function getInterventionsByCategory(
  category: string
): InterventionResult[] {
  return Object.values(PAPER_RESULTS.interventions).filter(
    (i) => i.category === category
  );
}
